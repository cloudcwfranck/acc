name: CI

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for changelog check

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Check formatting
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "Go code is not formatted:"
          gofmt -d .
          exit 1
        fi

    - name: Run tests
      run: go test -v ./...

    - name: Build acc
      run: go build -o acc ./cmd/acc

    - name: Test acc version
      run: ./acc version

    - name: Smoke test - acc init
      run: |
        mkdir -p test-project
        cd test-project
        ../acc init smoke-test --json
        cat acc.yaml
        ls -la .acc/policy/

    - name: Smoke test - verification gating
      run: |
        cd test-project
        # Create a Dockerfile that violates policy (runs as root)
        cat > Dockerfile <<EOF
        FROM alpine:latest
        # Intentionally running as root (violates no-root-user policy)
        RUN apk add --no-cache nginx
        CMD ["nginx", "-g", "daemon off;"]
        EOF

        # Try to verify (should fail because SBOM is missing)
        ../acc verify alpine:latest || echo "Verification failed as expected"

        # Show policy explain output
        ../acc policy explain || echo "No history yet"

    - name: Smoke test - acc inspect
      run: |
        cd test-project
        ../acc inspect alpine:latest || echo "Inspect completed (image may not exist)"

    - name: Verify help commands work
      run: |
        ./acc help
        ./acc init --help
        ./acc build --help
        ./acc verify --help
        ./acc run --help
        ./acc push --help
        ./acc promote --help
        ./acc attest --help
        ./acc inspect --help
        ./acc policy --help
        ./acc policy explain --help

  changelog:
    name: Changelog Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if CHANGELOG.md was updated
      run: |
        # Check if CHANGELOG.md has been modified in this PR
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
          echo "✅ CHANGELOG.md has been updated"
        else
          echo "❌ CHANGELOG.md has not been updated"
          echo ""
          echo "Please add an entry to CHANGELOG.md under the [Unreleased] section."
          echo "See docs/releasing.md for changelog guidelines."
          exit 1
        fi
