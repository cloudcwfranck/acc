name: CI Smoke Test

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Run tests
      run: go test ./...

    - name: Build acc
      run: go build -o acc ./cmd/acc

    - name: Test acc version
      run: ./acc version

    - name: Test acc init
      run: |
        mkdir -p test-project
        cd test-project
        ../acc init smoke-test --json
        cat acc.yaml
        ls -la .acc/policy/

    - name: Test verification gating with intentional failure
      run: |
        cd test-project
        # Create a Dockerfile that violates policy (runs as root)
        cat > Dockerfile <<EOF
        FROM alpine:latest
        # Intentionally running as root (violates no-root-user policy)
        RUN apk add --no-cache nginx
        CMD ["nginx", "-g", "daemon off;"]
        EOF

        # Try to verify (should fail because SBOM is missing)
        ../acc verify alpine:latest || echo "Verification failed as expected"

        # Show policy explain output
        ../acc policy explain || echo "No history yet"

    - name: Test acc inspect
      run: |
        cd test-project
        ../acc inspect alpine:latest || echo "Inspect completed (image may not exist)"

    - name: Verify help commands work
      run: |
        ./acc help
        ./acc init --help
        ./acc build --help
        ./acc verify --help
        ./acc run --help
        ./acc promote --help
        ./acc attest --help
        ./acc inspect --help
        ./acc policy --help
        ./acc policy explain --help
