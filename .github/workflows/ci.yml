name: CI

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]
  schedule:
    # Tier 2 nightly at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  packages: write  # For GHCR push in Tier 2

jobs:
  # ============================================================================
  # TIER 0: Command Registration & Help Text (ALWAYS RUNS, BLOCKS PR)
  # Fast checks that all commands exist and show help correctly
  # ============================================================================
  tier0-cli-help:
    name: "Tier 0: CLI Help Matrix"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Validate test scripts syntax
      run: |
        echo "Validating bash script syntax..."
        for script in scripts/*.sh; do
          echo "Checking $script"
          bash -n "$script"
        done

        # Run shellcheck if available (non-blocking)
        if command -v shellcheck &> /dev/null; then
          echo "Running shellcheck..."
          shellcheck scripts/*.sh || echo "⚠️  shellcheck warnings (non-blocking)"
        else
          echo "shellcheck not installed, skipping (optional)"
        fi

    - name: Build acc
      run: go build -o acc ./cmd/acc

    - name: Run CLI help matrix tests
      run: bash scripts/cli_help_matrix.sh

    - name: Upload Tier 0 logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: tier0-logs
        path: /tmp/tier0-*.log
        retention-days: 7

  # ============================================================================
  # TIER 1: Offline E2E Smoke Tests (ALWAYS RUNS, BLOCKS PR)
  # Comprehensive functional tests without external registry dependencies
  # ============================================================================
  tier1-e2e-smoke:
    name: "Tier 1: E2E Smoke Tests"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Check Go formatting
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "Go code is not formatted:"
          gofmt -d .
          exit 1
        fi

    - name: Run Go tests
      run: go test -v ./...

    - name: Build acc
      run: |
        go clean -cache -modcache
        go build -a -o acc ./cmd/acc

    - name: Install test dependencies
      run: |
        # Install OPA v0.66.0
        curl -L -o opa https://openpolicyagent.org/downloads/v0.66.0/opa_linux_amd64_static
        chmod +x opa
        sudo mv opa /usr/local/bin/
        opa version

        # Install jq
        sudo apt-get update
        sudo apt-get install -y jq

        # Install syft (required for SBOM generation)
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        syft version

    - name: Run E2E smoke tests
      run: bash scripts/e2e_smoke.sh

    - name: Upload Tier 1 artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: tier1-artifacts
        path: |
          /tmp/acc-e2e-*/
          /tmp/tier1-*.log
        retention-days: 7

  # ============================================================================
  # TIER 2: Registry Integration (OPTIONAL, SCHEDULED + TAGS, NEVER BLOCKS)
  # Tests push/promote workflows with GHCR
  # ============================================================================
  tier2-registry:
    name: "Tier 2: Registry Integration"
    runs-on: ubuntu-latest
    # Only run on schedule (nightly), tags, or main branch (not PRs)
    if: |
      github.event_name == 'schedule' ||
      startsWith(github.ref, 'refs/tags/') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build acc
      run: go build -o acc ./cmd/acc

    - name: Install test dependencies
      run: |
        # Install OPA
        curl -L -o opa https://openpolicyagent.org/downloads/v0.66.0/opa_linux_amd64_static
        chmod +x opa
        sudo mv opa /usr/local/bin/

        # Install jq
        sudo apt-get update
        sudo apt-get install -y jq

        # Install syft
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Run registry integration tests
      env:
        GHCR_REGISTRY: ghcr.io
        GHCR_REPO: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
      run: bash scripts/registry_integration.sh

    - name: Upload Tier 2 artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: tier2-artifacts
        path: |
          /tmp/acc-registry-*/
          /tmp/tier2-*.log
        retention-days: 7

  # ============================================================================
  # CHANGELOG CHECK (ONLY ON PRS, BLOCKS MERGE)
  # ============================================================================
  changelog-check:
    name: Changelog Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if CHANGELOG.md was updated
      run: |
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
          echo "✅ CHANGELOG.md has been updated"
        else
          echo "❌ CHANGELOG.md has not been updated"
          echo ""
          echo "Please add an entry to CHANGELOG.md under the [Unreleased] section."
          echo "See docs/testing-contract.md for changelog guidelines."
          exit 1
        fi
