name: Deployment Validation

# Validates released artifacts after a GitHub Release is published
# Ensures the actual binaries users install work correctly
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to validate (e.g., v0.3.3)'
        required: true
        type: string

jobs:
  validate-released-binary:
    name: Validate Released Binary
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            archive_name: linux_amd64.tar.gz
            binary_name: acc-linux-amd64
          - os: macos-latest
            archive_name: darwin_amd64.tar.gz
            binary_name: acc-darwin-amd64

    steps:
    - name: Determine release tag and version
      id: release_info
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG="${{ github.event.release.tag_name }}"
        fi

        # Strip 'v' prefix to get version number
        VERSION="${TAG#v}"

        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Validating release: $TAG (version: $VERSION)"

    - name: Download and extract released binary
      run: |
        TAG="${{ steps.release_info.outputs.tag }}"
        VERSION="${{ steps.release_info.outputs.version }}"
        ARCHIVE="acc_${VERSION}_${{ matrix.archive_name }}"
        BINARY="${{ matrix.binary_name }}"

        echo "Downloading $ARCHIVE from release $TAG..."

        # Download the release archive
        REPO="${{ github.repository }}"
        DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${TAG}/${ARCHIVE}"

        mkdir -p ./bin
        curl -L -f -o "./bin/${ARCHIVE}" "$DOWNLOAD_URL" || {
          echo "âŒ Failed to download release asset"
          echo "URL: $DOWNLOAD_URL"
          echo ""
          echo "Available assets for this release:"
          curl -s "https://api.github.com/repos/${REPO}/releases/tags/${TAG}" | \
            jq -r '.assets[].name' || echo "Could not fetch release info"
          exit 1
        }

        # Extract the binary
        cd ./bin
        tar -xzf "${ARCHIVE}" || {
          echo "âŒ Failed to extract archive"
          exit 1
        }

        # Rename binary to 'acc' for easier use
        mv "${BINARY}" acc
        chmod +x acc

        # Verify it's executable
        ./acc version > /dev/null 2>&1 || {
          echo "âŒ Binary is not executable or crashes"
          exit 1
        }

        echo "âœ… Downloaded and extracted binary successfully"

    - name: Add binary to PATH
      run: echo "$PWD/bin" >> $GITHUB_PATH

    - name: Validate binary version
      run: |
        VERSION="${{ steps.release_info.outputs.version }}"

        # Run version command
        VERSION_OUTPUT=$(acc version 2>&1)
        echo "Version output:"
        echo "$VERSION_OUTPUT"
        echo ""

        # Assert version contains the release version number
        if echo "$VERSION_OUTPUT" | grep -q "$VERSION"; then
          echo "âœ… Version matches release: $VERSION"
        else
          echo "âŒ Version does not match release"
          echo "Expected: $VERSION"
          echo "Got: $VERSION_OUTPUT"
          exit 1
        fi

    - name: Validate help command
      run: |
        # Basic sanity check that help works
        acc help > /dev/null 2>&1 || {
          echo "âŒ 'acc help' failed"
          exit 1
        }
        echo "âœ… 'acc help' works"

    - name: Set up Docker
      if: runner.os == 'Linux'
      run: |
        # Docker is pre-installed on GitHub Actions Ubuntu runners
        docker --version

    - name: Run deployment smoke test
      if: runner.os == 'Linux'  # Only run full test on Linux for speed
      run: |
        # Create temp working directory
        WORKDIR=$(mktemp -d)
        cd "$WORKDIR"
        echo "Working in: $WORKDIR"

        # Initialize a test project
        acc init test-project || {
          echo "âŒ 'acc init' failed"
          exit 1
        }
        echo "âœ… 'acc init' succeeded"
        cd test-project

        # Create a simple Dockerfile for testing
        cat > Dockerfile <<'EOF'
        FROM alpine:3.19
        USER 1000:1000
        CMD ["echo", "Hello from acc deployment test"]
        EOF

        # Build demo image
        docker build -t demo-app:deployment-test . || {
          echo "âŒ Docker build failed"
          exit 1
        }
        echo "âœ… Docker build succeeded"

        # Verify the image
        acc verify demo-app:deployment-test || {
          echo "âŒ 'acc verify' failed"
          exit 1
        }
        echo "âœ… 'acc verify' passed"

        # Attest the image (tests v0.3.3 signed envelopes)
        acc attest demo-app:deployment-test || {
          echo "âŒ 'acc attest' failed"
          exit 1
        }
        echo "âœ… 'acc attest' succeeded (with v0.3.3 signed envelope)"

        # Verify attestation exists and is valid
        acc trust verify demo-app:deployment-test || {
          echo "âŒ 'acc trust verify' failed"
          exit 1
        }
        echo "âœ… 'acc trust verify' passed"

        # Check that attestation file has envelope structure
        ATTEST_FILE=$(find .acc/attestations -name "*-attestation.json" | head -1)
        if [ -n "$ATTEST_FILE" ]; then
          if grep -q '"envelope"' "$ATTEST_FILE"; then
            echo "âœ… Attestation has v0.3.3 envelope (signed)"
          else
            echo "âš ï¸  Attestation does not have envelope (legacy format)"
          fi
        fi

        # Non-TTY regression test: Run workload in CI (non-TTY environment)
        # This must succeed without "the input device is not a TTY" error
        acc run demo-app:deployment-test -- echo "deployment test" || {
          echo "âŒ 'acc run' failed in non-TTY environment"
          exit 1
        }
        echo "âœ… 'acc run' succeeded in non-TTY environment"

        # Cleanup
        cd /
        rm -rf "$WORKDIR"

        echo ""
        echo "ðŸŽ‰ All deployment smoke tests passed!"
        echo "   The released binary is fully functional."

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: deployment-validation-logs-${{ matrix.os }}-${{ steps.release_info.outputs.tag }}
        path: |
          /tmp/acc-*.log
          ~/.acc/state/
        retention-days: 7
        if-no-files-found: ignore

  summary:
    name: Deployment Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-released-binary]
    if: always()

    steps:
    - name: Check results
      run: |
        if [ "${{ needs.validate-released-binary.result }}" = "success" ]; then
          echo "âœ… Released binary validation: PASSED"
          echo ""
          echo "ðŸŽ‰ Deployment validation completed successfully!"
          echo "The released artifacts are ready for users to install."
        else
          echo "âŒ Released binary validation: FAILED"
          echo ""
          echo "Release artifacts are NOT working correctly."
          echo "Please review the logs and fix the issues before announcing the release."
          exit 1
        fi
