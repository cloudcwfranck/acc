name: Deployment Validation

# Validates released artifacts after the Release workflow completes
# Ensures the actual binaries users install work correctly
# Uses workflow_run to avoid race conditions with asset uploads
on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to validate (e.g., v0.3.3)'
        required: true
        type: string

jobs:
  validate-released-binary:
    name: Validate Released Binary
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    # Only run if Release workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            archive_name: linux_amd64.tar.gz
            binary_name: acc-linux-amd64
          - os: macos-latest
            archive_name: darwin_amd64.tar.gz
            binary_name: acc-darwin-amd64

    steps:
    - name: Determine release tag and version
      id: release_info
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          # Extract tag from workflow_run event
          # The Release workflow runs on push to tags, so head_branch contains the tag
          TAG="${{ github.event.workflow_run.head_branch }}"

          if [ -z "$TAG" ]; then
            echo "âŒ Could not determine release tag from workflow_run event"
            echo "Event name: ${{ github.event_name }}"
            echo "Head branch: ${{ github.event.workflow_run.head_branch }}"
            echo "Head SHA: ${{ github.event.workflow_run.head_sha }}"
            exit 1
          fi
        fi

        # Strip 'v' prefix to get version number
        VERSION="${TAG#v}"

        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Validating release: $TAG (version: $VERSION)"

    - name: Download and extract released binary
      run: |
        TAG="${{ steps.release_info.outputs.tag }}"
        VERSION="${{ steps.release_info.outputs.version }}"
        ARCHIVE_PATTERN="acc_${VERSION}_${{ matrix.archive_name }}"
        BINARY="${{ matrix.binary_name }}"
        REPO="${{ github.repository }}"

        echo "Looking for asset matching: $ARCHIVE_PATTERN"
        echo "Release tag: $TAG"
        echo ""

        # Query GitHub API for release assets with retries
        MAX_RETRIES=10
        RETRY_DELAY=5
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_RETRIES ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt $ATTEMPT/$MAX_RETRIES: Fetching release assets..."

          # Get release info from GitHub API
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")

          # Check if release exists
          if echo "$RELEASE_JSON" | jq -e '.message == "Not Found"' > /dev/null 2>&1; then
            echo "âš ï¸  Release $TAG not found yet"
            if [ $ATTEMPT -lt $MAX_RETRIES ]; then
              echo "   Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
              continue
            else
              echo "âŒ Release $TAG still not found after $MAX_RETRIES attempts"
              exit 1
            fi
          fi

          # List all available assets for debugging
          echo "ðŸ“¦ Available assets:"
          echo "$RELEASE_JSON" | jq -r '.assets[].name' || echo "  (none)"
          echo ""

          # Find the asset matching our pattern
          DOWNLOAD_URL=$(echo "$RELEASE_JSON" | jq -r ".assets[] | select(.name == \"$ARCHIVE_PATTERN\") | .browser_download_url")

          if [ -n "$DOWNLOAD_URL" ] && [ "$DOWNLOAD_URL" != "null" ]; then
            echo "âœ… Found asset: $ARCHIVE_PATTERN"
            echo "   URL: $DOWNLOAD_URL"
            echo ""

            # Download the asset
            mkdir -p ./bin
            if curl -L -f -o "./bin/$ARCHIVE_PATTERN" "$DOWNLOAD_URL"; then
              echo "âœ… Downloaded successfully"
              break
            else
              echo "âš ï¸  Download failed"
              if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                echo "   Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                continue
              else
                echo "âŒ Download failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          else
            echo "âš ï¸  Asset $ARCHIVE_PATTERN not found yet"
            if [ $ATTEMPT -lt $MAX_RETRIES ]; then
              echo "   Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
              continue
            else
              echo "âŒ Asset $ARCHIVE_PATTERN not found after $MAX_RETRIES attempts"
              echo ""
              echo "Available assets:"
              echo "$RELEASE_JSON" | jq -r '.assets[].name'
              exit 1
            fi
          fi
        done

        # Extract the binary
        cd ./bin
        tar -xzf "$ARCHIVE_PATTERN" || {
          echo "âŒ Failed to extract archive"
          exit 1
        }

        # Rename binary to 'acc' for easier use
        mv "$BINARY" acc
        chmod +x acc

        # Verify it's executable
        ./acc version > /dev/null 2>&1 || {
          echo "âŒ Binary is not executable or crashes"
          exit 1
        }

        # Go back to workspace root
        cd ..

        echo "âœ… Downloaded and extracted binary successfully"

    - name: Add binary to PATH
      run: echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

    - name: Validate binary version
      run: |
        VERSION="${{ steps.release_info.outputs.version }}"

        # Run version command
        VERSION_OUTPUT=$(acc version 2>&1)
        echo "Version output:"
        echo "$VERSION_OUTPUT"
        echo ""

        # Assert version contains the release version number
        if echo "$VERSION_OUTPUT" | grep -q "$VERSION"; then
          echo "âœ… Version matches release: $VERSION"
        else
          echo "âŒ Version does not match release"
          echo "Expected: $VERSION"
          echo "Got: $VERSION_OUTPUT"
          exit 1
        fi

    - name: Validate help command
      run: |
        # Basic sanity check that help works
        acc help > /dev/null 2>&1 || {
          echo "âŒ 'acc help' failed"
          exit 1
        }
        echo "âœ… 'acc help' works"

    - name: Set up Docker
      if: runner.os == 'Linux'
      run: |
        # Docker is pre-installed on GitHub Actions Ubuntu runners
        docker --version

    - name: Run deployment smoke test
      if: runner.os == 'Linux'  # Only run full test on Linux for speed
      run: |
        # Create temp working directory
        WORKDIR=$(mktemp -d)
        cd "$WORKDIR"
        echo "Working in: $WORKDIR"

        # Initialize a test project
        acc init test-project || {
          echo "âŒ 'acc init' failed"
          exit 1
        }
        echo "âœ… 'acc init' succeeded"
        cd test-project

        # Create a simple Dockerfile for testing
        cat > Dockerfile <<'EOF'
        FROM alpine:3.19
        USER 1000:1000
        CMD ["echo", "Hello from acc deployment test"]
        EOF

        # Build demo image
        docker build -t demo-app:deployment-test . || {
          echo "âŒ Docker build failed"
          exit 1
        }
        echo "âœ… Docker build succeeded"

        # Verify the image
        acc verify demo-app:deployment-test || {
          echo "âŒ 'acc verify' failed"
          exit 1
        }
        echo "âœ… 'acc verify' passed"

        # Attest the image (tests v0.3.3 signed envelopes)
        acc attest demo-app:deployment-test || {
          echo "âŒ 'acc attest' failed"
          exit 1
        }
        echo "âœ… 'acc attest' succeeded (with v0.3.3 signed envelope)"

        # Verify attestation exists and is valid
        acc trust verify demo-app:deployment-test || {
          echo "âŒ 'acc trust verify' failed"
          exit 1
        }
        echo "âœ… 'acc trust verify' passed"

        # Check that attestation file has envelope structure
        ATTEST_FILE=$(find .acc/attestations -name "*-attestation.json" | head -1)
        if [ -n "$ATTEST_FILE" ]; then
          if grep -q '"envelope"' "$ATTEST_FILE"; then
            echo "âœ… Attestation has v0.3.3 envelope (signed)"
          else
            echo "âš ï¸  Attestation does not have envelope (legacy format)"
          fi
        fi

        # Non-TTY regression test: Run workload in CI (non-TTY environment)
        # This must succeed without "the input device is not a TTY" error
        acc run demo-app:deployment-test -- echo "deployment test" || {
          echo "âŒ 'acc run' failed in non-TTY environment"
          exit 1
        }
        echo "âœ… 'acc run' succeeded in non-TTY environment"

        # Cleanup
        cd /
        rm -rf "$WORKDIR"

        echo ""
        echo "ðŸŽ‰ All deployment smoke tests passed!"
        echo "   The released binary is fully functional."

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: deployment-validation-logs-${{ matrix.os }}-${{ steps.release_info.outputs.tag }}
        path: |
          /tmp/acc-*.log
          ~/.acc/state/
        retention-days: 7
        if-no-files-found: ignore

  summary:
    name: Deployment Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-released-binary]
    if: always()

    steps:
    - name: Check results
      run: |
        if [ "${{ needs.validate-released-binary.result }}" = "success" ]; then
          echo "âœ… Released binary validation: PASSED"
          echo ""
          echo "ðŸŽ‰ Deployment validation completed successfully!"
          echo "The released artifacts are ready for users to install."
        else
          echo "âŒ Released binary validation: FAILED"
          echo ""
          echo "Release artifacts are NOT working correctly."
          echo "Please review the logs and fix the issues before announcing the release."
          exit 1
        fi
