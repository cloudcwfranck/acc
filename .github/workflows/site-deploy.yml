name: Deploy Site to Vercel

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read

jobs:
  trigger-vercel-deploy:
    name: Trigger Vercel Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Check for deploy hook
        id: check
        run: |
          if [ -z "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}" ]; then
            echo "has_hook=false" >> $GITHUB_OUTPUT
          else
            echo "has_hook=true" >> $GITHUB_OUTPUT
          fi

      - name: Skip if no deploy hook
        if: steps.check.outputs.has_hook == 'false'
        run: |
          echo "‚ö†Ô∏è  VERCEL_DEPLOY_HOOK_URL secret not configured"
          echo "To enable automatic site deployments on release:"
          echo "1. Create a Deploy Hook in Vercel project settings"
          echo "2. Add the URL as a repository secret: VERCEL_DEPLOY_HOOK_URL"
          echo ""
          echo "Skipping deployment (exit 0 - this is not an error)"
          exit 0

      - name: Trigger Vercel deployment
        if: steps.check.outputs.has_hook == 'true'
        run: |
          echo "üöÄ Triggering Vercel deployment via deploy hook..."

          RESPONSE=$(curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}" \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s)

          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)

          if [ "$HTTP_STATUS" = "201" ] || [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Deployment triggered successfully"
            echo "Visit your Vercel dashboard to monitor deployment progress"
          else
            echo "‚ùå Deployment trigger failed with status: $HTTP_STATUS"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: Log release info
        if: github.event_name == 'release'
        run: |
          echo "üì¶ Release: ${{ github.event.release.tag_name }}"
          echo "üìÑ Release notes: ${{ github.event.release.html_url }}"
          echo ""
          echo "The website will automatically update via ISR (Incremental Static Regeneration)"
          echo "within 5 minutes, or immediately if the deploy hook was triggered successfully."
