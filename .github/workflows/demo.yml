name: Demo Validation

on:
  push:
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'demo/**'
      - '.github/workflows/demo.yml'
  workflow_dispatch:

jobs:
  validate-demo:
    runs-on: ubuntu-latest
    name: Validate Interactive Demo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.66.0/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Install syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build acc
        run: go build -o ./acc ./cmd/acc

      - name: Validate demo workflow
        run: bash demo/run.sh
        env:
          ACC_BIN: ${{ github.workspace }}/acc

      - name: Verify demo.cast was created
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          if [ -f demo/demo.cast ]; then
            echo "✅ demo.cast created successfully"
            ls -lh demo/demo.cast
          else
            echo "❌ demo.cast was not created by demo/run.sh"
            echo "Contents of demo directory:"
            ls -la demo/ || echo "Demo directory doesn't exist"
            exit 1
          fi

      - name: Upload demo.cast as artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: demo-recording
          path: demo/demo.cast
          if-no-files-found: error

  # Upload demo recording to GitHub Release
  upload-to-release:
    runs-on: ubuntu-latest
    needs: validate-demo
    # Only run on version tags AND if validate-demo succeeded
    if: startsWith(github.ref, 'refs/tags/v') && needs.validate-demo.result == 'success'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download demo artifact
        id: download
        uses: actions/download-artifact@v4
        with:
          name: demo-recording
          path: ./demo-files
        continue-on-error: true

      - name: Verify demo.cast exists
        id: verify
        run: |
          if [ "${{ steps.download.outcome }}" != "success" ]; then
            echo "❌ Failed to download artifact 'demo-recording'"
            echo "The artifact may not have been uploaded in the validate-demo job"
            exit 1
          fi

          if [ ! -f demo-files/demo.cast ]; then
            echo "❌ demo.cast not found in artifact"
            echo "Contents of demo-files:"
            ls -la demo-files/ || echo "Directory is empty or doesn't exist"
            exit 1
          fi
          echo "✅ demo.cast found"
          ls -lh demo-files/demo.cast

      - name: Upload to release
        if: steps.verify.outcome == 'success'
        uses: softprops/action-gh-release@v2
        with:
          files: demo-files/demo.cast
          fail_on_unmatched_files: true
          # The action automatically handles re-runs by replacing existing assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify upload success
        if: steps.verify.outcome == 'success'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "✅ Successfully uploaded demo.cast to release $TAG"
          echo "   View at: https://github.com/${{ github.repository }}/releases/tag/$TAG"
