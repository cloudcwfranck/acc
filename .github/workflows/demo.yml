name: Demo Validation

on:
  push:
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'demo/**'
      - '.github/workflows/demo.yml'
  workflow_dispatch:

jobs:
  validate-demo:
    runs-on: ubuntu-latest
    name: Validate Interactive Demo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.66.0/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Install syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build acc
        run: go build -o ./acc ./cmd/acc

      - name: Validate demo workflow
        run: bash demo/run.sh
        env:
          ACC_BIN: ${{ github.workspace }}/acc

      - name: Upload demo.cast as artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: demo-recording
          path: demo/demo.cast
          if-no-files-found: warn

  # Optional: Upload to release if this is a tag
  upload-to-release:
    runs-on: ubuntu-latest
    needs: validate-demo
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download demo artifact
        uses: actions/download-artifact@v4
        with:
          name: demo-recording
          path: ./demo-files

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            demo-files/demo.cast
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
